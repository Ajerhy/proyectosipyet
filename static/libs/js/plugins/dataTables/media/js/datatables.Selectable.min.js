/*
 * Selectable is a feature plugin for DataTables that provides ability to select rows.
 *
 * Author:      Basil Gren
 * License:     MIT
 * Version:     1.0.2 (25-Jul-2012)
 */
(function(e){function n(e){this._aoData=[];this._oSelectable=e;this._sIdColumnName=null}function r(r,i){this.options=e.extend({},t,i);this.oTable=r.oInstance;this.oSelection=new n(this);this.oDTSettings=r;r.oSelection=this.oSelection;this.oSelection._sIdColumnName=i.sIdColumnName;r._oSelectable=this;this.$selectAll=null;this.nControls=null;this.nCounter=null;if(this.options.bShowControls){var s=e('<div><span class="selection_counter"></span> | </div>');s.addClass(this.options.sControlsClass);var o=s.find(".selection_counter");var u=e('<a class="selection_clear">'+this.options.oLanguage.sClearSelection+"</a>");u.on("click",function(){r.oSelection.fnClear()});s.append(u);this.nCounter=o[0];this.nControls=s[0];this._fnUpdateCounter()}this._fnInit()}var t={iColNumber:1,sIdColumnName:null,bShowControls:true,bSingleRowSelect:false,bSelectAllCheckbox:false,sSelectionTrigger:"checkbox",fnSelectionChanged:null,sSelectedRowClass:"selected",sControlsClass:"dataTables_selectionControls",oLanguage:{sSelectedRows:"Selected rows: _COUNT_",sClearSelection:"Clear selection"}};n.prototype._fnUpdate=function(e){this._oSelectable._fnUpdate(e)};n.prototype.fnGetData=function(){if(this._sIdColumnName)return null;return this._aoData};n.prototype.fnGetIds=function(){if(this._sIdColumnName)return this._aoData;return null};n.prototype.fnGetSize=function(){return this._aoData.length};n.prototype.fnIsSelected=function(e){if(this._sIdColumnName){if(typeof e=="object")e=e[this._sIdColumnName]}for(var t=0,n=this._aoData.length;t<n;t++)if(this._aoData[t]==e)return true;return false};n.prototype.fnAdd=function(e){if(this._oSelectable.options.bSingleRowSelect)this.fnClear();if(this._sIdColumnName){if(typeof e=="object")e=e[this._sIdColumnName]}this._aoData.push(e);this._fnUpdate(e);this._oSelectable._fnSelectionChanged()};n.prototype.fnRemove=function(e){if(this._sIdColumnName){if(typeof e=="object")e=e[this._sIdColumnName]}for(var t=0,n=this._aoData.length;t<n;t++){if(this._aoData[t]==e){this._aoData.splice(t,1);this._fnUpdate(e);this._oSelectable._fnSelectionChanged();break}}};n.prototype.fnClear=function(){if(this._aoData.length==0)return;this._aoData=[];this._oSelectable._fnUnselectAll();this._oSelectable._fnSelectionChanged()};r.prototype._fnInit=function(){var t=this;this._massChange=false;if(this.options.bSelectAllCheckbox&&!this.options.bSingleRowSelect)this.oDTSettings.oApi._fnCallbackReg(this.oDTSettings,"aoInitComplete",function(){var n=e(t.oDTSettings.nTHead).find("tr :nth-child("+t.options.iColNumber+")");var r=e(t.oDTSettings.nTBody).find("td:nth-child("+t.options.iColNumber+")");var i=e('<input type="checkbox" />');t.$selectAll=i;i.groupToggle({groupParent:r,onBeforeChange:function(){t._massChange=true},onChanged:function(){t._massChange=false;t._fnSelectionChanged()}});n.html(i)},"SelectableInitCallback");this.oDTSettings.oApi._fnCallbackReg(this.oDTSettings,"aoRowCallback",this._fnRowCallback,"SelectableRowCallback");this.oDTSettings.oApi._fnCallbackReg(this.oDTSettings,"aoDrawCallback",function(){if(t.$selectAll)t.$selectAll.groupToggle("update")},"SelectableDrawCallback");this.oDTSettings.oInstance.fnDraw(false)};r.prototype._fnSetRowAppearance=function(e,t){var n=this._fnGetCheckbox(e);if(t){e.addClass(this.options.sSelectedRowClass);n.attr("checked","checked")}else{e.removeClass(this.options.sSelectedRowClass);n.removeAttr("checked")}};r.prototype._onCheckboxChanged=function(t){var n=t.data;var r=e(this).closest("tr");var i=n.fnGetData(r[0]);if(e(this).is(":checked"))n.fnGetSelection().fnAdd(i);else n.fnGetSelection().fnRemove(i)};r.prototype._fnGetCheckbox=function(e){return e.find("td:nth-child("+this.options.iColNumber+") input:checkbox")};r.prototype._fnUpdate=function(t){var n=this.oTable.fnGetData();var r=0,i,s=this.options.sIdColumnName;if(s){for(i=n.length;r<i;r++)if(n[r][s]==t)break}else{for(i=n.length;r<i;r++)if(n[r]==t)break}if(r<i){var o=e(this.oTable.fnGetNodes(r));this._fnSetRowAppearance(o,this.oSelection.fnIsSelected(t))}this._fnUpdateCounter()};r.prototype._fnUpdateCounter=function(){if(!this.nCounter)return;this.nCounter.innerHTML=this.options.oLanguage.sSelectedRows.replace("_COUNT_",this.oSelection.fnGetSize())};r.prototype._fnUnselectAll=function(){var t=this.oTable.$("tr");for(var n=0,r=t.length;n<r;n++)this._fnSetRowAppearance(e(t[n]),false);this._fnUpdateCounter()};r.prototype._fnRowCallback=function(t,n){var r=this.fnSettings()._oSelectable;var i=r.options;var s=e(t);var o=s.find("td:nth-child("+i.iColNumber+")");var u=o.find("input:checkbox");if(u.length!=0)return;u=e('<input type="checkbox" />');u.on("change",this,r._onCheckboxChanged);var a=null;if(i.sSelectionTrigger=="cell")a=o;else if(i.sSelectionTrigger=="row")a=s;if(a){u.on("click",function(e){e.stopPropagation()});a.on("click",function(){u.click()})}o.empty().append(u);if(this.fnGetSelection().fnIsSelected(n))r._fnSetRowAppearance(s,true)};r.prototype._fnSelectionChanged=function(){if(this._massChange)return;if(typeof this.options.fnSelectionChanged=="function")this.options.fnSelectionChanged(this.oSelection)};e.fn.dataTableExt.aoFeatures.push({fnInit:function(e){var t=typeof e.oInit.oSelectable!="undefined"?e.oInit.oSelectable:{};var n=new r(e,t);return n.nControls},cFeature:"L",sFeature:"Selectable"});e.fn.dataTableExt.oApi.fnGetSelection=function(e){return e.oSelection}})(jQuery)